{"ast":null,"code":"\"use strict\";\n\nvar _interopRequireDefault = require(\"@babel/runtime/helpers/interopRequireDefault\");\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\nexports.addStorageEventListener = addStorageEventListener;\nexports.averageResponseTime = averageResponseTime;\nexports.canBeUsed = canBeUsed;\nexports.close = close;\nexports.create = create;\nexports[\"default\"] = void 0;\nexports.keccak256 = keccak256;\nexports.microSeconds = void 0;\nexports.onMessage = onMessage;\nexports.postMessage = postMessage;\nexports.removeStorageEventListener = removeStorageEventListener;\nexports.storageKey = storageKey;\nexports.type = void 0;\n\nvar _regenerator = _interopRequireDefault(require(\"@babel/runtime/regenerator\"));\n\nvar _asyncToGenerator2 = _interopRequireDefault(require(\"@babel/runtime/helpers/asyncToGenerator\"));\n\nvar _obliviousSet = require(\"oblivious-set\");\n\nvar _socket = require(\"socket.io-client\");\n\nvar _eccrypto = require(\"@toruslabs/eccrypto\");\n\nvar _metadataHelpers = require(\"@toruslabs/metadata-helpers\");\n\nvar _keccak = _interopRequireDefault(require(\"keccak\"));\n\nvar _util = require(\"../util\");\n\nvar _options = require(\"../options\");\n/**\n * A localStorage-only method which uses localstorage and its 'storage'-event\n * This does not work inside of webworkers because they have no access to locastorage\n * This is basically implemented to support IE9 or your grandmothers toaster.\n * @link https://caniuse.com/#feat=namevalue-storage\n * @link https://caniuse.com/#feat=indexeddb\n */\n\n\nvar microSeconds = _util.microSeconds; // PASS IN STRING/BUFFER TO GET BUFFER\n\nexports.microSeconds = microSeconds;\n\nfunction keccak256(a) {\n  return (0, _keccak[\"default\"])('keccak256').update(a).digest();\n}\n\nvar KEY_PREFIX = 'pubkey.broadcastChannel-';\nvar type = 'server';\nexports.type = type;\nvar SOCKET_CONN_INSTANCES = {};\n\nfunction storageKey(channelName) {\n  return KEY_PREFIX + channelName;\n}\n/**\n * writes the new message to the storage\n * and fires the storage-event so other readers can find it\n */\n\n\nfunction postMessage(channelState, messageJson) {\n  return new Promise(function (res, rej) {\n    (0, _util.sleep)().then( /*#__PURE__*/(0, _asyncToGenerator2[\"default\"])( /*#__PURE__*/_regenerator[\"default\"].mark(function _callee3() {\n      var key, channelEncPrivKey, encData, socketConn, _setMessage, currentAttempts, waitingInterval;\n\n      return _regenerator[\"default\"].wrap(function _callee3$(_context3) {\n        while (1) {\n          switch (_context3.prev = _context3.next) {\n            case 0:\n              key = storageKey(channelState.channelName);\n              channelEncPrivKey = keccak256(key);\n              _context3.next = 4;\n              return (0, _metadataHelpers.encryptData)(channelEncPrivKey.toString('hex'), {\n                token: (0, _util.randomToken)(),\n                time: new Date().getTime(),\n                data: messageJson,\n                uuid: channelState.uuid\n              });\n\n            case 4:\n              encData = _context3.sent;\n              socketConn = SOCKET_CONN_INSTANCES[channelState.channelName];\n\n              _setMessage = /*#__PURE__*/function () {\n                var _ref2 = (0, _asyncToGenerator2[\"default\"])( /*#__PURE__*/_regenerator[\"default\"].mark(function _callee() {\n                  return _regenerator[\"default\"].wrap(function _callee$(_context) {\n                    while (1) {\n                      switch (_context.prev = _context.next) {\n                        case 0:\n                          _context.t0 = fetch;\n                          _context.t1 = channelState.serverUrl + '/channel/set';\n                          _context.t2 = JSON;\n                          _context.t3 = (0, _eccrypto.getPublic)(channelEncPrivKey).toString('hex');\n                          _context.t4 = encData;\n                          _context.next = 7;\n                          return (0, _eccrypto.sign)(channelEncPrivKey, keccak256(encData));\n\n                        case 7:\n                          _context.t5 = _context.sent.toString('hex');\n                          _context.t6 = {\n                            key: _context.t3,\n                            data: _context.t4,\n                            signature: _context.t5\n                          };\n                          _context.t7 = _context.t2.stringify.call(_context.t2, _context.t6);\n                          _context.t8 = {\n                            'Content-Type': 'application/json; charset=utf-8'\n                          };\n                          _context.t9 = {\n                            method: 'POST',\n                            body: _context.t7,\n                            headers: _context.t8\n                          };\n                          return _context.abrupt(\"return\", (0, _context.t0)(_context.t1, _context.t9).then(res)[\"catch\"](rej));\n\n                        case 13:\n                        case \"end\":\n                          return _context.stop();\n                      }\n                    }\n                  }, _callee);\n                }));\n\n                return function _setMessage() {\n                  return _ref2.apply(this, arguments);\n                };\n              }();\n\n              if (!(socketConn && socketConn.connected)) {\n                _context3.next = 9;\n                break;\n              }\n\n              return _context3.abrupt(\"return\", _setMessage());\n\n            case 9:\n              currentAttempts = 0;\n              waitingInterval = window.setInterval( /*#__PURE__*/(0, _asyncToGenerator2[\"default\"])( /*#__PURE__*/_regenerator[\"default\"].mark(function _callee2() {\n                return _regenerator[\"default\"].wrap(function _callee2$(_context2) {\n                  while (1) {\n                    switch (_context2.prev = _context2.next) {\n                      case 0:\n                        if (!(currentAttempts >= 5)) {\n                          _context2.next = 3;\n                          break;\n                        }\n\n                        window.clearInterval(waitingInterval);\n                        return _context2.abrupt(\"return\", rej(new Error('Could not post message after 5 attempts to socket channel')));\n\n                      case 3:\n                        if (!(socketConn && socketConn.connected)) {\n                          _context2.next = 8;\n                          break;\n                        }\n\n                        window.clearInterval(waitingInterval);\n                        return _context2.abrupt(\"return\", _setMessage());\n\n                      case 8:\n                        currentAttempts++;\n\n                      case 9:\n                      case \"end\":\n                        return _context2.stop();\n                    }\n                  }\n                }, _callee2);\n              })), 500);\n\n            case 11:\n            case \"end\":\n              return _context3.stop();\n          }\n        }\n      }, _callee3);\n    })));\n  });\n}\n\nfunction addStorageEventListener(channelName, serverUrl, fn) {\n  var key = storageKey(channelName);\n  var channelEncPrivKey = keccak256(key);\n  var SOCKET_CONN = (0, _socket.io)(serverUrl, {\n    transports: ['websocket', 'polling'],\n    // use WebSocket first, if available\n    withCredentials: true,\n    reconnectionDelayMax: 10000,\n    reconnectionAttempts: 10\n  });\n\n  var visibilityListener = function visibilityListener() {\n    // if channel is closed, then remove the listener.\n    if (!SOCKET_CONN_INSTANCES[channelName]) {\n      document.removeEventListener('visibilitychange', visibilityListener);\n      return;\n    } // if not connected, then wait for connection and ping server for latest msg.\n\n\n    if (!SOCKET_CONN.connected && document.visibilityState === 'visible') {\n      SOCKET_CONN.once('connect', /*#__PURE__*/(0, _asyncToGenerator2[\"default\"])( /*#__PURE__*/_regenerator[\"default\"].mark(function _callee4() {\n        return _regenerator[\"default\"].wrap(function _callee4$(_context4) {\n          while (1) {\n            switch (_context4.prev = _context4.next) {\n              case 0:\n                SOCKET_CONN.emit('check_auth_status', (0, _eccrypto.getPublic)(channelEncPrivKey).toString('hex'));\n\n              case 1:\n              case \"end\":\n                return _context4.stop();\n            }\n          }\n        }, _callee4);\n      })));\n    }\n  };\n\n  var listener = /*#__PURE__*/function () {\n    var _ref5 = (0, _asyncToGenerator2[\"default\"])( /*#__PURE__*/_regenerator[\"default\"].mark(function _callee5(ev) {\n      var decData;\n      return _regenerator[\"default\"].wrap(function _callee5$(_context5) {\n        while (1) {\n          switch (_context5.prev = _context5.next) {\n            case 0:\n              _context5.prev = 0;\n              _context5.next = 3;\n              return (0, _metadataHelpers.decryptData)(channelEncPrivKey.toString('hex'), ev);\n\n            case 3:\n              decData = _context5.sent;\n              fn(decData);\n              _context5.next = 10;\n              break;\n\n            case 7:\n              _context5.prev = 7;\n              _context5.t0 = _context5[\"catch\"](0);\n\n              _util.log.error(_context5.t0);\n\n            case 10:\n            case \"end\":\n              return _context5.stop();\n          }\n        }\n      }, _callee5, null, [[0, 7]]);\n    }));\n\n    return function listener(_x) {\n      return _ref5.apply(this, arguments);\n    };\n  }();\n\n  SOCKET_CONN.on('connect_error', function () {\n    // revert to classic upgrade\n    SOCKET_CONN.io.opts.transports = ['polling', 'websocket'];\n  });\n  SOCKET_CONN.on('connect', /*#__PURE__*/(0, _asyncToGenerator2[\"default\"])( /*#__PURE__*/_regenerator[\"default\"].mark(function _callee6() {\n    var engine;\n    return _regenerator[\"default\"].wrap(function _callee6$(_context6) {\n      while (1) {\n        switch (_context6.prev = _context6.next) {\n          case 0:\n            _util.log.debug('connected with socket');\n\n            SOCKET_CONN.emit('check_auth_status', (0, _eccrypto.getPublic)(channelEncPrivKey).toString('hex'));\n            engine = SOCKET_CONN.io.engine;\n\n            _util.log.debug('initially connected to', engine.transport.name); // in most cases, prints \"polling\"\n\n\n            engine.once('upgrade', function () {\n              // called when the transport is upgraded (i.e. from HTTP long-polling to WebSocket)\n              _util.log.debug('upgraded', engine.transport.name); // in most cases, prints \"websocket\"\n\n            });\n            engine.on('close', function (reason) {\n              // called when the underlying connection is closed\n              _util.log.debug('connection closed', reason);\n            });\n\n          case 6:\n          case \"end\":\n            return _context6.stop();\n        }\n      }\n    }, _callee6);\n  })));\n  SOCKET_CONN.on('error', function (err) {\n    _util.log.debug('socket errored', err);\n\n    SOCKET_CONN.disconnect();\n  });\n  SOCKET_CONN.once('disconnect', function () {\n    _util.log.debug('socket disconnected');\n\n    if (SOCKET_CONN_INSTANCES[channelName]) visibilityListener();\n  });\n  SOCKET_CONN.on('success', listener);\n  document.addEventListener('visibilitychange', visibilityListener);\n  SOCKET_CONN_INSTANCES[channelName] = SOCKET_CONN;\n  return listener;\n}\n\nfunction removeStorageEventListener(channelState) {\n  if (SOCKET_CONN_INSTANCES[channelState.channelName]) SOCKET_CONN_INSTANCES[channelState.channelName].disconnect();\n}\n\nfunction create(channelName, options) {\n  options = (0, _options.fillOptionsWithDefaults)(options);\n\n  if (!canBeUsed(options)) {\n    throw new Error('BroadcastChannel: server cannot be used');\n  }\n\n  var uuid = (0, _util.randomToken)();\n  /**\n   * eMIs\n   * contains all messages that have been emitted before\n   * @type {ObliviousSet}\n   */\n\n  var eMIs = new _obliviousSet.ObliviousSet(options.server.removeTimeout);\n  var state = {\n    channelName: channelName,\n    uuid: uuid,\n    eMIs: eMIs,\n    // emittedMessagesIds\n    serverUrl: options.server.url\n  };\n  state.listener = addStorageEventListener(channelName, options.server.url, function (msgObj) {\n    if (!state.messagesCallback) return; // no listener\n\n    if (msgObj.uuid === uuid) return; // own message\n\n    if (!msgObj.token || eMIs.has(msgObj.token)) return; // already emitted\n    // if (msgObj.data.time && msgObj.data.time < state.messagesCallbackTime) return; // too old\n\n    eMIs.add(msgObj.token);\n    state.messagesCallback(msgObj.data);\n  });\n  return state;\n}\n\nfunction close(channelState) {\n  // give 2 sec for all msgs which are in transit to be consumed\n  // by receiver.\n  window.setTimeout(function () {\n    removeStorageEventListener(channelState);\n    delete SOCKET_CONN_INSTANCES[channelState.channelName];\n  }, 1000);\n}\n\nfunction onMessage(channelState, fn, time) {\n  channelState.messagesCallbackTime = time;\n  channelState.messagesCallback = fn;\n}\n\nfunction canBeUsed() {\n  return true;\n}\n\nfunction averageResponseTime() {\n  var defaultTime = 500; // TODO: Maybe increase it based on operation\n\n  return defaultTime;\n}\n\nvar _default = {\n  create: create,\n  close: close,\n  onMessage: onMessage,\n  postMessage: postMessage,\n  canBeUsed: canBeUsed,\n  type: type,\n  averageResponseTime: averageResponseTime,\n  microSeconds: microSeconds\n};\nexports[\"default\"] = _default;","map":{"version":3,"sources":["C:/DaoWebsite/node_modules/@toruslabs/broadcast-channel/dist/lib/methods/server.js"],"names":["_interopRequireDefault","require","Object","defineProperty","exports","value","addStorageEventListener","averageResponseTime","canBeUsed","close","create","keccak256","microSeconds","onMessage","postMessage","removeStorageEventListener","storageKey","type","_regenerator","_asyncToGenerator2","_obliviousSet","_socket","_eccrypto","_metadataHelpers","_keccak","_util","_options","a","update","digest","KEY_PREFIX","SOCKET_CONN_INSTANCES","channelName","channelState","messageJson","Promise","res","rej","sleep","then","mark","_callee3","key","channelEncPrivKey","encData","socketConn","_setMessage","currentAttempts","waitingInterval","wrap","_callee3$","_context3","prev","next","encryptData","toString","token","randomToken","time","Date","getTime","data","uuid","sent","_ref2","_callee","_callee$","_context","t0","fetch","t1","serverUrl","t2","JSON","t3","getPublic","t4","sign","t5","t6","signature","t7","stringify","call","t8","t9","method","body","headers","abrupt","stop","apply","arguments","connected","window","setInterval","_callee2","_callee2$","_context2","clearInterval","Error","fn","SOCKET_CONN","io","transports","withCredentials","reconnectionDelayMax","reconnectionAttempts","visibilityListener","document","removeEventListener","visibilityState","once","_callee4","_callee4$","_context4","emit","listener","_ref5","_callee5","ev","decData","_callee5$","_context5","decryptData","log","error","_x","on","opts","_callee6","engine","_callee6$","_context6","debug","transport","name","reason","err","disconnect","addEventListener","options","fillOptionsWithDefaults","eMIs","ObliviousSet","server","removeTimeout","state","url","msgObj","messagesCallback","has","add","setTimeout","messagesCallbackTime","defaultTime","_default"],"mappings":"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","sourcesContent":["\"use strict\";\n\nvar _interopRequireDefault = require(\"@babel/runtime/helpers/interopRequireDefault\");\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\nexports.addStorageEventListener = addStorageEventListener;\nexports.averageResponseTime = averageResponseTime;\nexports.canBeUsed = canBeUsed;\nexports.close = close;\nexports.create = create;\nexports[\"default\"] = void 0;\nexports.keccak256 = keccak256;\nexports.microSeconds = void 0;\nexports.onMessage = onMessage;\nexports.postMessage = postMessage;\nexports.removeStorageEventListener = removeStorageEventListener;\nexports.storageKey = storageKey;\nexports.type = void 0;\n\nvar _regenerator = _interopRequireDefault(require(\"@babel/runtime/regenerator\"));\n\nvar _asyncToGenerator2 = _interopRequireDefault(require(\"@babel/runtime/helpers/asyncToGenerator\"));\n\nvar _obliviousSet = require(\"oblivious-set\");\n\nvar _socket = require(\"socket.io-client\");\n\nvar _eccrypto = require(\"@toruslabs/eccrypto\");\n\nvar _metadataHelpers = require(\"@toruslabs/metadata-helpers\");\n\nvar _keccak = _interopRequireDefault(require(\"keccak\"));\n\nvar _util = require(\"../util\");\n\nvar _options = require(\"../options\");\n\n/**\n * A localStorage-only method which uses localstorage and its 'storage'-event\n * This does not work inside of webworkers because they have no access to locastorage\n * This is basically implemented to support IE9 or your grandmothers toaster.\n * @link https://caniuse.com/#feat=namevalue-storage\n * @link https://caniuse.com/#feat=indexeddb\n */\nvar microSeconds = _util.microSeconds; // PASS IN STRING/BUFFER TO GET BUFFER\n\nexports.microSeconds = microSeconds;\n\nfunction keccak256(a) {\n  return (0, _keccak[\"default\"])('keccak256').update(a).digest();\n}\n\nvar KEY_PREFIX = 'pubkey.broadcastChannel-';\nvar type = 'server';\nexports.type = type;\nvar SOCKET_CONN_INSTANCES = {};\n\nfunction storageKey(channelName) {\n  return KEY_PREFIX + channelName;\n}\n/**\n * writes the new message to the storage\n * and fires the storage-event so other readers can find it\n */\n\n\nfunction postMessage(channelState, messageJson) {\n  return new Promise(function (res, rej) {\n    (0, _util.sleep)().then( /*#__PURE__*/(0, _asyncToGenerator2[\"default\"])( /*#__PURE__*/_regenerator[\"default\"].mark(function _callee3() {\n      var key, channelEncPrivKey, encData, socketConn, _setMessage, currentAttempts, waitingInterval;\n\n      return _regenerator[\"default\"].wrap(function _callee3$(_context3) {\n        while (1) {\n          switch (_context3.prev = _context3.next) {\n            case 0:\n              key = storageKey(channelState.channelName);\n              channelEncPrivKey = keccak256(key);\n              _context3.next = 4;\n              return (0, _metadataHelpers.encryptData)(channelEncPrivKey.toString('hex'), {\n                token: (0, _util.randomToken)(),\n                time: new Date().getTime(),\n                data: messageJson,\n                uuid: channelState.uuid\n              });\n\n            case 4:\n              encData = _context3.sent;\n              socketConn = SOCKET_CONN_INSTANCES[channelState.channelName];\n\n              _setMessage = /*#__PURE__*/function () {\n                var _ref2 = (0, _asyncToGenerator2[\"default\"])( /*#__PURE__*/_regenerator[\"default\"].mark(function _callee() {\n                  return _regenerator[\"default\"].wrap(function _callee$(_context) {\n                    while (1) {\n                      switch (_context.prev = _context.next) {\n                        case 0:\n                          _context.t0 = fetch;\n                          _context.t1 = channelState.serverUrl + '/channel/set';\n                          _context.t2 = JSON;\n                          _context.t3 = (0, _eccrypto.getPublic)(channelEncPrivKey).toString('hex');\n                          _context.t4 = encData;\n                          _context.next = 7;\n                          return (0, _eccrypto.sign)(channelEncPrivKey, keccak256(encData));\n\n                        case 7:\n                          _context.t5 = _context.sent.toString('hex');\n                          _context.t6 = {\n                            key: _context.t3,\n                            data: _context.t4,\n                            signature: _context.t5\n                          };\n                          _context.t7 = _context.t2.stringify.call(_context.t2, _context.t6);\n                          _context.t8 = {\n                            'Content-Type': 'application/json; charset=utf-8'\n                          };\n                          _context.t9 = {\n                            method: 'POST',\n                            body: _context.t7,\n                            headers: _context.t8\n                          };\n                          return _context.abrupt(\"return\", (0, _context.t0)(_context.t1, _context.t9).then(res)[\"catch\"](rej));\n\n                        case 13:\n                        case \"end\":\n                          return _context.stop();\n                      }\n                    }\n                  }, _callee);\n                }));\n\n                return function _setMessage() {\n                  return _ref2.apply(this, arguments);\n                };\n              }();\n\n              if (!(socketConn && socketConn.connected)) {\n                _context3.next = 9;\n                break;\n              }\n\n              return _context3.abrupt(\"return\", _setMessage());\n\n            case 9:\n              currentAttempts = 0;\n              waitingInterval = window.setInterval( /*#__PURE__*/(0, _asyncToGenerator2[\"default\"])( /*#__PURE__*/_regenerator[\"default\"].mark(function _callee2() {\n                return _regenerator[\"default\"].wrap(function _callee2$(_context2) {\n                  while (1) {\n                    switch (_context2.prev = _context2.next) {\n                      case 0:\n                        if (!(currentAttempts >= 5)) {\n                          _context2.next = 3;\n                          break;\n                        }\n\n                        window.clearInterval(waitingInterval);\n                        return _context2.abrupt(\"return\", rej(new Error('Could not post message after 5 attempts to socket channel')));\n\n                      case 3:\n                        if (!(socketConn && socketConn.connected)) {\n                          _context2.next = 8;\n                          break;\n                        }\n\n                        window.clearInterval(waitingInterval);\n                        return _context2.abrupt(\"return\", _setMessage());\n\n                      case 8:\n                        currentAttempts++;\n\n                      case 9:\n                      case \"end\":\n                        return _context2.stop();\n                    }\n                  }\n                }, _callee2);\n              })), 500);\n\n            case 11:\n            case \"end\":\n              return _context3.stop();\n          }\n        }\n      }, _callee3);\n    })));\n  });\n}\n\nfunction addStorageEventListener(channelName, serverUrl, fn) {\n  var key = storageKey(channelName);\n  var channelEncPrivKey = keccak256(key);\n  var SOCKET_CONN = (0, _socket.io)(serverUrl, {\n    transports: ['websocket', 'polling'],\n    // use WebSocket first, if available\n    withCredentials: true,\n    reconnectionDelayMax: 10000,\n    reconnectionAttempts: 10\n  });\n\n  var visibilityListener = function visibilityListener() {\n    // if channel is closed, then remove the listener.\n    if (!SOCKET_CONN_INSTANCES[channelName]) {\n      document.removeEventListener('visibilitychange', visibilityListener);\n      return;\n    } // if not connected, then wait for connection and ping server for latest msg.\n\n\n    if (!SOCKET_CONN.connected && document.visibilityState === 'visible') {\n      SOCKET_CONN.once('connect', /*#__PURE__*/(0, _asyncToGenerator2[\"default\"])( /*#__PURE__*/_regenerator[\"default\"].mark(function _callee4() {\n        return _regenerator[\"default\"].wrap(function _callee4$(_context4) {\n          while (1) {\n            switch (_context4.prev = _context4.next) {\n              case 0:\n                SOCKET_CONN.emit('check_auth_status', (0, _eccrypto.getPublic)(channelEncPrivKey).toString('hex'));\n\n              case 1:\n              case \"end\":\n                return _context4.stop();\n            }\n          }\n        }, _callee4);\n      })));\n    }\n  };\n\n  var listener = /*#__PURE__*/function () {\n    var _ref5 = (0, _asyncToGenerator2[\"default\"])( /*#__PURE__*/_regenerator[\"default\"].mark(function _callee5(ev) {\n      var decData;\n      return _regenerator[\"default\"].wrap(function _callee5$(_context5) {\n        while (1) {\n          switch (_context5.prev = _context5.next) {\n            case 0:\n              _context5.prev = 0;\n              _context5.next = 3;\n              return (0, _metadataHelpers.decryptData)(channelEncPrivKey.toString('hex'), ev);\n\n            case 3:\n              decData = _context5.sent;\n              fn(decData);\n              _context5.next = 10;\n              break;\n\n            case 7:\n              _context5.prev = 7;\n              _context5.t0 = _context5[\"catch\"](0);\n\n              _util.log.error(_context5.t0);\n\n            case 10:\n            case \"end\":\n              return _context5.stop();\n          }\n        }\n      }, _callee5, null, [[0, 7]]);\n    }));\n\n    return function listener(_x) {\n      return _ref5.apply(this, arguments);\n    };\n  }();\n\n  SOCKET_CONN.on('connect_error', function () {\n    // revert to classic upgrade\n    SOCKET_CONN.io.opts.transports = ['polling', 'websocket'];\n  });\n  SOCKET_CONN.on('connect', /*#__PURE__*/(0, _asyncToGenerator2[\"default\"])( /*#__PURE__*/_regenerator[\"default\"].mark(function _callee6() {\n    var engine;\n    return _regenerator[\"default\"].wrap(function _callee6$(_context6) {\n      while (1) {\n        switch (_context6.prev = _context6.next) {\n          case 0:\n            _util.log.debug('connected with socket');\n\n            SOCKET_CONN.emit('check_auth_status', (0, _eccrypto.getPublic)(channelEncPrivKey).toString('hex'));\n            engine = SOCKET_CONN.io.engine;\n\n            _util.log.debug('initially connected to', engine.transport.name); // in most cases, prints \"polling\"\n\n\n            engine.once('upgrade', function () {\n              // called when the transport is upgraded (i.e. from HTTP long-polling to WebSocket)\n              _util.log.debug('upgraded', engine.transport.name); // in most cases, prints \"websocket\"\n\n            });\n            engine.on('close', function (reason) {\n              // called when the underlying connection is closed\n              _util.log.debug('connection closed', reason);\n            });\n\n          case 6:\n          case \"end\":\n            return _context6.stop();\n        }\n      }\n    }, _callee6);\n  })));\n  SOCKET_CONN.on('error', function (err) {\n    _util.log.debug('socket errored', err);\n\n    SOCKET_CONN.disconnect();\n  });\n  SOCKET_CONN.once('disconnect', function () {\n    _util.log.debug('socket disconnected');\n\n    if (SOCKET_CONN_INSTANCES[channelName]) visibilityListener();\n  });\n  SOCKET_CONN.on('success', listener);\n  document.addEventListener('visibilitychange', visibilityListener);\n  SOCKET_CONN_INSTANCES[channelName] = SOCKET_CONN;\n  return listener;\n}\n\nfunction removeStorageEventListener(channelState) {\n  if (SOCKET_CONN_INSTANCES[channelState.channelName]) SOCKET_CONN_INSTANCES[channelState.channelName].disconnect();\n}\n\nfunction create(channelName, options) {\n  options = (0, _options.fillOptionsWithDefaults)(options);\n\n  if (!canBeUsed(options)) {\n    throw new Error('BroadcastChannel: server cannot be used');\n  }\n\n  var uuid = (0, _util.randomToken)();\n  /**\n   * eMIs\n   * contains all messages that have been emitted before\n   * @type {ObliviousSet}\n   */\n\n  var eMIs = new _obliviousSet.ObliviousSet(options.server.removeTimeout);\n  var state = {\n    channelName: channelName,\n    uuid: uuid,\n    eMIs: eMIs,\n    // emittedMessagesIds\n    serverUrl: options.server.url\n  };\n  state.listener = addStorageEventListener(channelName, options.server.url, function (msgObj) {\n    if (!state.messagesCallback) return; // no listener\n\n    if (msgObj.uuid === uuid) return; // own message\n\n    if (!msgObj.token || eMIs.has(msgObj.token)) return; // already emitted\n    // if (msgObj.data.time && msgObj.data.time < state.messagesCallbackTime) return; // too old\n\n    eMIs.add(msgObj.token);\n    state.messagesCallback(msgObj.data);\n  });\n  return state;\n}\n\nfunction close(channelState) {\n  // give 2 sec for all msgs which are in transit to be consumed\n  // by receiver.\n  window.setTimeout(function () {\n    removeStorageEventListener(channelState);\n    delete SOCKET_CONN_INSTANCES[channelState.channelName];\n  }, 1000);\n}\n\nfunction onMessage(channelState, fn, time) {\n  channelState.messagesCallbackTime = time;\n  channelState.messagesCallback = fn;\n}\n\nfunction canBeUsed() {\n  return true;\n}\n\nfunction averageResponseTime() {\n  var defaultTime = 500; // TODO: Maybe increase it based on operation\n\n  return defaultTime;\n}\n\nvar _default = {\n  create: create,\n  close: close,\n  onMessage: onMessage,\n  postMessage: postMessage,\n  canBeUsed: canBeUsed,\n  type: type,\n  averageResponseTime: averageResponseTime,\n  microSeconds: microSeconds\n};\nexports[\"default\"] = _default;"]},"metadata":{},"sourceType":"script"}